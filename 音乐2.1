local player = game:GetService("Players").LocalPlayer
local userInputService = game:GetService("UserInputService")
local replicatedStorage = game:GetService("ReplicatedStorage")
local tweenService = game:GetService("TweenService")

if not player:FindFirstChild("PlayerGui") then player:WaitForChild("PlayerGui") end

-- æ·»åŠ åœ†è§’æ•ˆæœçš„å‡½æ•°
local function ApplyRoundedCorners(uiElement, cornerRadius)
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, cornerRadius or 8)
    uiCorner.Parent = uiElement
    return uiCorner
end

local function CreateFullUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MusicPlayerUI_"..math.random(1000,9999)
    screenGui.ResetOnSpawn = false
    screenGui.DisplayOrder = 999
    screenGui.Parent = player.PlayerGui

    -- ==================== ä¸»å®¹å™¨ç¾åŒ– ====================
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 300, 0, 200)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    mainFrame.BackgroundTransparency = 0
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    -- ä¸»å®¹å™¨æ¸å˜æ•ˆæœï¼ˆç‹¬ç«‹ï¼Œä¸å½±å“å†…éƒ¨å…ƒç´ ï¼‰
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 45, 60)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 35))
    })
    gradient.Rotation = 45
    gradient.Parent = mainFrame
    
    ApplyRoundedCorners(mainFrame, 12)
    
    -- ä¸»å®¹å™¨é˜´å½±ï¼ˆç‹¬ç«‹ï¼‰
    local mainStroke = Instance.new("UIStroke")
    mainStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    mainStroke.Color = Color3.fromRGB(0, 0, 0)
    mainStroke.Transparency = 0.8
    mainStroke.Thickness = 2
    mainStroke.Parent = mainFrame
    
    -- ==================== æ ‡é¢˜æ ç¾åŒ– ====================
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, -20, 0, 30)
    titleBar.Position = UDim2.new(0, 10, 0, 5)
    titleBar.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
    titleBar.BackgroundTransparency = 0
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    -- æ ‡é¢˜æ æ¸å˜ï¼ˆç‹¬ç«‹ï¼‰
    local titleGradient = Instance.new("UIGradient")
    titleGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 100, 220)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(60, 80, 160))
    })
    titleGradient.Rotation = 90
    titleGradient.Parent = titleBar
    
    ApplyRoundedCorners(titleBar, 8)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -80, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Text = "MUSIC PLAYER â™ªâ™ª[made byä½™å®¢]"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.BackgroundTransparency = 1
    titleLabel.Parent = titleBar

    -- ==================== æ§åˆ¶æŒ‰é’®ï¼ˆç‹¬ç«‹é¢œè‰²ç³»ç»Ÿï¼‰ ====================
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -30, 0.5, -12.5)
    closeButton.AnchorPoint = Vector2.new(1, 0.5)
    closeButton.Text = "Ã—"
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 18
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.BackgroundColor3 = Color3.fromRGB(220, 80, 80) -- ç‹¬ç«‹çº¢è‰²
    closeButton.BorderSizePixel = 0
    closeButton.Parent = titleBar
    ApplyRoundedCorners(closeButton, 6)
    
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    local twinButton = Instance.new("TextButton")
    twinButton.Size = UDim2.new(0, 25, 0, 25)
    twinButton.Position = UDim2.new(1, -65, 0.5, -12.5)
    twinButton.AnchorPoint = Vector2.new(1, 0.5)
    twinButton.Text = "T"
    twinButton.Font = Enum.Font.GothamBold
    twinButton.TextSize = 12
    twinButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    twinButton.BackgroundColor3 = Color3.fromRGB(100, 100, 180) -- ç‹¬ç«‹ç´«è‰²
    twinButton.BorderSizePixel = 0
    twinButton.Parent = titleBar
    ApplyRoundedCorners(twinButton, 6)

    -- ==================== è¾“å…¥æ¡†ç¾åŒ–ï¼ˆç‹¬ç«‹æ¸å˜ç³»ç»Ÿï¼‰ ====================
    local function CreateInputBox(posY, placeholder, sizeX, posX)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(sizeX, 0, 0, 28)
        container.Position = UDim2.new(posX, 0, posY, 0)
        container.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
        container.BorderSizePixel = 0
        container.Parent = mainFrame
        
        -- è¾“å…¥æ¡†ç‹¬ç«‹æ¸å˜
        local inputGradient = Instance.new("UIGradient")
        inputGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(60, 60, 75)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 45, 60))
        })
        inputGradient.Parent = container
        
        ApplyRoundedCorners(container, 6)
        
        -- è¾“å…¥æ¡†ç‹¬ç«‹é˜´å½±
        local inputStroke = Instance.new("UIStroke")
        inputStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        inputStroke.Color = Color3.fromRGB(0, 0, 0)
        inputStroke.Transparency = 0.8
        inputStroke.Thickness = 1
        inputStroke.Parent = container
        
        local box = Instance.new("TextBox")
        box.Size = UDim2.new(1, -10, 1, -6)
        box.Position = UDim2.new(0, 5, 0, 3)
        box.PlaceholderText = placeholder
        box.BackgroundTransparency = 1
        box.TextColor3 = Color3.fromRGB(255, 255, 255)
        box.Font = Enum.Font.Gotham
        box.TextSize = 12
        box.PlaceholderColor3 = Color3.fromRGB(180, 180, 200)
        box.Parent = container
        
        return box
    end

    local musicIDBox = CreateInputBox(0.2, "è¾“å…¥éŸ³ä¹ID...", 0.9, 0.05)
    local volumeBox = CreateInputBox(0.4, "éŸ³é‡ 0.1-100", 0.4, 0.05)
    local pitchBox = CreateInputBox(0.4, "éŸ³è°ƒ 0.1-100", 0.4, 0.55)

    -- ==================== åŠŸèƒ½æŒ‰é’®ç¾åŒ–ï¼ˆå…³é”®ä¿®å¤ï¼šç‹¬ç«‹çš„é¢œè‰²ç³»ç»Ÿï¼‰ ====================
    local function CreateStyledButton(text, posX, posY, sizeX, defaultColor, isPlayButton)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(sizeX, 0, 0, 32)
        btn.Position = UDim2.new(posX, 0, posY, 0)
        btn.Text = text
        btn.Font = Enum.Font.GothamSemibold
        btn.TextSize = 13
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.BackgroundColor3 = defaultColor
        btn.AutoButtonColor = true
        btn.BorderSizePixel = 0
        btn.Parent = mainFrame
        
        -- æŒ‰é’®ç‹¬ç«‹æ¸å˜ï¼ˆä¸ä¸å…¶ä»–æŒ‰é’®å…±äº«ï¼‰
        local btnGradient = Instance.new("UIGradient")
        btnGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(
                math.min(defaultColor.R * 255 + 15, 255),
                math.min(defaultColor.G * 255 + 15, 255),
                math.min(defaultColor.B * 255 + 15, 255)
            )),
            ColorSequenceKeypoint.new(1, defaultColor)
        })
        btnGradient.Rotation = 90
        btnGradient.Parent = btn
        
        ApplyRoundedCorners(btn, 8)
        
        -- æŒ‰é’®ç‹¬ç«‹é˜´å½±
        local btnStroke = Instance.new("UIStroke")
        btnStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        btnStroke.Color = Color3.fromRGB(0, 0, 0)
        btnStroke.Transparency = 0.8
        btnStroke.Thickness = 1
        btnStroke.Parent = btn
        
        -- ä»…ä¸ºæ’­æ”¾æŒ‰é’®æ·»åŠ çŠ¶æ€æ ‡è®°
        if isPlayButton then
            btn:SetAttribute("IsPlayButton", true)
        end
        
        return btn
    end

    -- ==================== å…³é”®ä¿®å¤ï¼šæ’­æ”¾æŒ‰é’®ç‹¬ç«‹é¢œè‰²ç³»ç»Ÿ ====================
    local playButtonDefaultColor = Color3.fromRGB(0, 162, 255) -- Robloxå®˜æ–¹è“è‰²
    local playButtonSuccessColor = Color3.fromRGB(70, 200, 100) -- æˆåŠŸç»¿è‰²
    local playButtonFailureColor = Color3.fromRGB(220, 80, 80) -- å¤±è´¥çº¢è‰²
    
    -- åˆ›å»ºæ’­æ”¾æŒ‰é’®ï¼ˆæ ‡è®°ä¸ºç‰¹æ®ŠæŒ‰é’®ï¼‰
    local playButton = CreateStyledButton("æ’­æ”¾", 0.05, 0.65, 0.4, playButtonDefaultColor, true)
    -- åœæ­¢æŒ‰é’®ä½¿ç”¨ç‹¬ç«‹é¢œè‰²
    local stopButton = CreateStyledButton("åœæ­¢", 0.55, 0.65, 0.4, Color3.fromRGB(150, 80, 80), false)

    -- ==================== åˆ‡æ¢æŒ‰é’®ç¾åŒ–ï¼ˆç‹¬ç«‹é¢œè‰²ï¼‰ ====================
    local function CreateToggleButton(text, posX, posY, sizeX, color)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(sizeX, 0, 0, 24)
        btn.Position = UDim2.new(posX, 0, posY, 0)
        btn.Text = text
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 11
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.BackgroundColor3 = color
        btn.AutoButtonColor = true
        btn.BorderSizePixel = 0
        btn.Parent = mainFrame
        
        -- åˆ‡æ¢æŒ‰é’®ç‹¬ç«‹æ¸å˜
        local toggleGradient = Instance.new("UIGradient")
        toggleGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(
                math.min(color.R * 255 + 10, 255),
                math.min(color.G * 255 + 10, 255),
                math.min(color.B * 255 + 10, 255)
            )),
            ColorSequenceKeypoint.new(1, color)
        })
        toggleGradient.Parent = btn
        
        ApplyRoundedCorners(btn, 6)
        
        -- åˆ‡æ¢æŒ‰é’®ç‹¬ç«‹é˜´å½±
        local toggleStroke = Instance.new("UIStroke")
        toggleStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        toggleStroke.Color = Color3.fromRGB(0, 0, 0)
        toggleStroke.Transparency = 0.8
        toggleStroke.Thickness = 1
        toggleStroke.Parent = btn
        
        return btn
    end

    local loopToggle = CreateToggleButton("å¾ªç¯: ON", 0.55, 0.85, 0.4, Color3.fromRGB(70, 150, 200))
    local modeButton = CreateToggleButton("æ™ºèƒ½æ¨¡å¼", 0.05, 0.85, 0.4, Color3.fromRGB(150, 100, 220))

    -- ==================== åˆ†éš”çº¿ ====================
    local separator = Instance.new("Frame")
    separator.Size = UDim2.new(1, -20, 0, 1)
    separator.Position = UDim2.new(0, 10, 0.58, 0)
    separator.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    separator.BorderSizePixel = 0
    separator.Parent = mainFrame

    -- ==================== æ‹–åŠ¨ç³»ç»Ÿ ====================
    mainFrame.Active = true
    mainFrame.Draggable = true

    -- ==================== éŸ³é¢‘æ§åˆ¶ç³»ç»Ÿ ====================
    local soundSystem = {
        LoopEnabled = true,
        ActiveSounds = {},
        RemoteEvent = nil,
        CurrentMode = "auto",
        ModeNames = {auto = "æ™ºèƒ½æ¨¡å¼", mode1 = "ç¼“å­˜æ¨¡å¼", mode2 = "éå†æ¨¡å¼"},
        ModeColors = {
            auto = Color3.fromRGB(150, 100, 220),
            mode1 = Color3.fromRGB(100, 180, 120),
            mode2 = Color3.fromRGB(220, 140, 100)
        },
        LastSoundName = nil,
        TwinMode = false
    }
    
    local function UpdateModeButton()
        modeButton.Text = soundSystem.ModeNames[soundSystem.CurrentMode]
        modeButton.BackgroundColor3 = soundSystem.ModeColors[soundSystem.CurrentMode]
    end
    
    modeButton.MouseButton1Click:Connect(function()
        soundSystem.CurrentMode = soundSystem.CurrentMode == "auto" and "mode1" or 
                                 soundSystem.CurrentMode == "mode1" and "mode2" or "auto"
        UpdateModeButton()
    end)
    
    local function UpdateTwinModeButton()
        twinButton.BackgroundColor3 = soundSystem.TwinMode and 
            Color3.fromRGB(70, 130, 200) or Color3.fromRGB(100, 100, 180)
    end
    
    twinButton.MouseButton1Click:Connect(function()
        soundSystem.TwinMode = not soundSystem.TwinMode
        UpdateTwinModeButton()
    end)
    
    UpdateModeButton()
    UpdateTwinModeButton()
    
    -- ==================== éŸ³ä¹æ§åˆ¶åŠŸèƒ½ ====================
    local function generateNaturalName()
        local prefixes = {"Music", "Sound", "Track", "Audio", "BG", "SFX", "Ambient"}
        local suffixes = {"Player", "System", "Device", "Box", "Machine", "Unit"}
        return prefixes[math.random(#prefixes)].."_"..suffixes[math.random(#suffixes)].."_"..math.random(1000,9999)
    end
    
    local function generateMusicIDName(musicID)
        return #musicID < 6 and "Audio_"..musicID or "Audio_"..musicID:sub(-6)
    end
    
    local function generateRandomName()
        local chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
        local name = ""
        for i = 1, math.random(8,12) do
            name = name .. string.sub(chars, math.random(1, #chars), math.random(1, #chars))
        end
        return name
    end
    
    local function generateSoundName(musicID)
        local strategies = {generateNaturalName, generateRandomName, function() return generateMusicIDName(musicID) end}
        return strategies[math.random(#strategies)]()
    end
    
    local function SafeStopSound(soundID)
        local stopped = false
        for _, location in ipairs({workspace, replicatedStorage}) do
            for _, obj in ipairs(location:GetDescendants()) do
                if obj:IsA("RemoteEvent") and obj.Name == "AC6_FE_Sounds" then
                    pcall(function()
                        obj:FireServer("stopSound", soundID)
                        stopped = true
                    end)
                end
            end
        end
        return stopped
    end

    local function StopAllSounds()
        if #soundSystem.ActiveSounds == 0 then return end
        
        local soundsToStop = {}
        for _, soundID in ipairs(soundSystem.ActiveSounds) do
            table.insert(soundsToStop, soundID)
        end
        
        for _, soundID in ipairs(soundsToStop) do
            SafeStopSound(soundID)
        end
        
        soundSystem.ActiveSounds = {}
        soundSystem.LastSoundName = nil
    end

    local function Mode1_Play(musicID, volume, pitch, loopEnabled)
        if soundSystem.RemoteEvent and not soundSystem.RemoteEvent:IsDescendantOf(game) then
            soundSystem.RemoteEvent = nil
        end
        
        if not soundSystem.RemoteEvent then
            for _, location in ipairs({workspace, replicatedStorage}) do
                for _, obj in ipairs(location:GetDescendants()) do
                    if obj:IsA("RemoteEvent") and obj.Name == "AC6_FE_Sounds" then
                        soundSystem.RemoteEvent = obj
                        break
                    end
                end
                if soundSystem.RemoteEvent then break end
            end
        end
        
        if not soundSystem.RemoteEvent then return false end
        
        local soundName = generateSoundName(musicID)
        local success = pcall(function()
            soundSystem.RemoteEvent:FireServer("newSound", soundName, workspace, 
                              "rbxassetid://"..musicID, pitch, volume, loopEnabled)
            soundSystem.RemoteEvent:FireServer("playSound", soundName)
        end)
        
        if success then
            table.insert(soundSystem.ActiveSounds, soundName)
            soundSystem.LastSoundName = soundName
            return true
        else
            soundSystem.RemoteEvent = nil
            return false
        end
    end

    local function Mode2_Play(musicID, volume, pitch, loopEnabled)
        local soundName = generateSoundName(musicID)
        local playedSuccessfully = false
        local remoteEvents = {}
        
        for _, location in ipairs({workspace, replicatedStorage}) do
            for _, v in ipairs(location:GetDescendants()) do
                if v:IsA("RemoteEvent") and v.Name == "AC6_FE_Sounds" then
                    table.insert(remoteEvents, v)
                end
            end
        end
        
        if #remoteEvents == 0 then return false end
        
        for _, remote in ipairs(remoteEvents) do
            local success = pcall(function()
                remote:FireServer("newSound", soundName, workspace, 
                                  "rbxassetid://"..musicID, pitch, volume, loopEnabled)
                remote:FireServer("playSound", soundName)
            end)
            
            if success then
                playedSuccessfully = true
                if not soundSystem.TwinMode then break end
            end
        end
        
        if playedSuccessfully then
            table.insert(soundSystem.ActiveSounds, soundName)
            soundSystem.LastSoundName = soundName
        end
        return playedSuccessfully
    end
    
    local function AutoMode_Play(musicID, volume, pitch, loopEnabled)
        return Mode1_Play(musicID, volume, pitch, loopEnabled) or Mode2_Play(musicID, volume, pitch, loopEnabled)
    end
    
    -- ==================== å…³é”®ä¿®å¤ï¼šæ’­æ”¾æŒ‰é’®ç‹¬ç«‹çŠ¶æ€åé¦ˆç³»ç»Ÿ ====================
    local function handlePlayback()
        local musicID = musicIDBox.Text:gsub("%D+", "")
        if not musicID:match("^%d+$") or #musicID < 6 then return end
        
        local volume = math.clamp(tonumber(volumeBox.Text) or 1, 0.1, 100)
        local pitch = math.clamp(tonumber(pitchBox.Text) or 1, 0.1, 100)
        
        local success = false
        if soundSystem.CurrentMode == "mode1" then
            success = Mode1_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        elseif soundSystem.CurrentMode == "mode2" then
            success = Mode2_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        else
            success = AutoMode_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        end
        
        -- å…³é”®ä¿®å¤ï¼šä»…æ’­æ”¾æŒ‰é’®æ”¹å˜é¢œè‰²ï¼Œä¸å½±å“å…¶ä»–æŒ‰é’®
        if success then
            -- æ’­æ”¾æˆåŠŸï¼šé—ªåŠ¨ç»¿è‰²ï¼ˆä»…å½±å“æ’­æ”¾æŒ‰é’®ï¼‰
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local successTween = tweenService:Create(playButton, tweenInfo, {BackgroundColor3 = playButtonSuccessColor})
            successTween:Play()
        else
            -- æ’­æ”¾å¤±è´¥ï¼šé—ªåŠ¨çº¢è‰²ï¼ˆä»…å½±å“æ’­æ”¾æŒ‰é’®ï¼‰
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local failureTween = tweenService:Create(playButton, tweenInfo, {BackgroundColor3 = playButtonFailureColor})
            failureTween:Play()
        end
        
        -- 1ç§’åä»…æ¢å¤æ’­æ”¾æŒ‰é’®çš„é¢œè‰²
        task.delay(1.0, function()
            local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local restoreTween = tweenService:Create(playButton, tweenInfo, {BackgroundColor3 = playButtonDefaultColor})
            restoreTween:Play()
        end)
    end

    local function handleStop()
        StopAllSounds()
        -- åœæ­¢æŒ‰é’®çš„é¢œè‰²å˜åŒ–ç‹¬ç«‹äºæ’­æ”¾æŒ‰é’®
        stopButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
        task.delay(0.5, function()
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = tweenService:Create(stopButton, tweenInfo, {BackgroundColor3 = Color3.fromRGB(150, 80, 80)})
            tween:Play()
        end)
    end
    
    playButton.MouseButton1Click:Connect(handlePlayback)
    stopButton.MouseButton1Click:Connect(handleStop)
    loopToggle.MouseButton1Click:Connect(function()
        soundSystem.LoopEnabled = not soundSystem.LoopEnabled
        loopToggle.Text = soundSystem.LoopEnabled and "å¾ªç¯: ON" or "å¾ªç¯: OFF"
        loopToggle.BackgroundColor3 = soundSystem.LoopEnabled and 
            Color3.fromRGB(70, 150, 200) or Color3.fromRGB(120, 120, 140)
    end)

    return screenGui
end

CreateFullUI()
print("ğŸµ éŸ³ä¹æ’­æ”¾å™¨UIå·²åŠ è½½ - æŒ‰é’®é¢œè‰²æ±¡æŸ“é—®é¢˜å·²å½»åº•ä¿®å¤ï¼")
