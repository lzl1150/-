local player = game:GetService("Players").LocalPlayer
local userInputService = game:GetService("UserInputService")
local replicatedStorage = game:GetService("ReplicatedStorage")
local tweenService = game:GetService("TweenService")
local runService = game:GetService("RunService")

if not player:FindFirstChild("PlayerGui") then 
    player:WaitForChild("PlayerGui") 
end

-- æ·»åŠ åœ†è§’æ•ˆæœçš„å‡½æ•°
local function ApplyRoundedCorners(uiElement, cornerRadius)
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, cornerRadius or 8)
    uiCorner.Parent = uiElement
    return uiCorner
end

-- è¾‰å…‰æ•ˆæœå‡½æ•°
local function ApplyEnhancedGlowEffect(uiElement, elementType)
    local baseStroke = Instance.new("UIStroke")
    baseStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    baseStroke.Color = Color3.fromRGB(0, 0, 0)
    baseStroke.Transparency = 0.8
    baseStroke.Thickness = 1
    baseStroke.Parent = uiElement

    if elementType == "mainFrame" then
        local innerGlow = Instance.new("UIStroke")
        innerGlow.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        innerGlow.Color = Color3.fromRGB(90, 40, 130)
        innerGlow.Transparency = 0.75
        innerGlow.Thickness = 3
        innerGlow.Parent = uiElement
        
        local midGlow = Instance.new("UIStroke")
        midGlow.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        midGlow.Color = Color3.fromRGB(130, 60, 190)
        midGlow.Transparency = 0.82
        midGlow.Thickness = 5
        midGlow.Parent = uiElement
        
        local outerGlow = Instance.new("UIStroke")
        outerGlow.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        outerGlow.Color = Color3.fromRGB(160, 80, 220)
        outerGlow.Transparency = 0.88
        outerGlow.Thickness = 7
        outerGlow.Parent = uiElement
        
        return {innerGlow, midGlow, outerGlow}
    else
        local elementGlow = Instance.new("UIStroke")
        elementGlow.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        elementGlow.Color = Color3.fromRGB(100, 50, 160)
        elementGlow.Transparency = 0.85
        elementGlow.Thickness = 1.5
        elementGlow.Parent = uiElement
        
        return elementGlow
    end
end

-- å¯¹æŠ—æ€§å±æ€§é”å®šåŠŸèƒ½ï¼ˆä»…åœ¨éåŸå§‹ä»£ç æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰
local BoostProtectionManager = {
    Enabled = false,
    ActiveProtections = {}
}

function BoostProtectionManager:EnableProtection(soundName)
    if not self.Enabled then return end
    
    task.delay(0.5, function()
        local soundInstance = nil
        
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("Sound") and obj.Name == soundName then
                soundInstance = obj
                break
            end
        end
        
        if soundInstance then
            local protectionTask = {}
            protectionTask.sound = soundInstance
            protectionTask.running = true
            
            protectionTask.thread = task.spawn(function()
                while protectionTask.running and protectionTask.sound and protectionTask.sound.Parent do
                    pcall(function()
                        protectionTask.sound.Disabled = false
                        protectionTask.sound.Playing = true
                        protectionTask.sound.Looped = true
                    end)
                    task.wait(0.1)
                end
            end)
            
            self.ActiveProtections[soundName] = protectionTask
            print("âœ… Boostä¿æŠ¤å·²å¯ç”¨: " .. soundName)
        end
    end)
end

function BoostProtectionManager:DisableProtection(soundName)
    if self.ActiveProtections[soundName] then
        self.ActiveProtections[soundName].running = false
        self.ActiveProtections[soundName] = nil
        print("ğŸ”’ Boostä¿æŠ¤å·²åœæ­¢: " .. soundName)
    end
end

function BoostProtectionManager:StopAllProtections()
    for soundName, protection in pairs(self.ActiveProtections) do
        protection.running = false
    end
    self.ActiveProtections = {}
    print("ğŸ”’ æ‰€æœ‰Boostä¿æŠ¤å·²åœæ­¢")
end

local function CreateFullUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MusicPlayerUI_"..math.random(1000,9999)
    screenGui.ResetOnSpawn = false
    screenGui.DisplayOrder = 999
    
    local success, err = pcall(function()
        screenGui.Parent = player.PlayerGui
    end)
    
    if not success then
        warn("UIçˆ¶çº§è®¾ç½®å¤±è´¥: " .. tostring(err))
        return nil
    end

    -- ä¸»å®¹å™¨
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 300, 0, 200)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(120, 120, 130)
    mainFrame.BackgroundTransparency = 0
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = true
    mainFrame.Parent = screenGui

    -- ä¸»å®¹å™¨æ¸å˜æ•ˆæœ
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(85, 85, 90)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(35, 35, 50))
    })
    gradient.Rotation = 45
    gradient.Parent = mainFrame
    
    ApplyRoundedCorners(mainFrame, 12)
    ApplyEnhancedGlowEffect(mainFrame, "mainFrame")

    -- æ ‡é¢˜æ 
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, -5.1, 0, 30)
    titleBar.Position = UDim2.new(0, 3.5, 0, 2.5)
    titleBar.BackgroundColor3 = Color3.fromRGB(115, 115, 125)
    titleBar.BackgroundTransparency = 0
    titleBar.BorderSizePixel = 0
    titleBar.Visible = true
    titleBar.Parent = mainFrame
    
    local titleGradient = Instance.new("UIGradient")
    titleGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(75, 105, 185)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(60, 80, 160))
    })
    titleGradient.Rotation = 90
    titleGradient.Parent = titleBar
    
    ApplyRoundedCorners(titleBar, 8)
    ApplyEnhancedGlowEffect(titleBar, "element")
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -45, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Text = "MUSIC PLAYERâ™ª[made byä½™å®¢]"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.BackgroundTransparency = 1
    titleLabel.Visible = true
    titleLabel.Parent = titleBar

    -- æ§åˆ¶æŒ‰é’®
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -7, 0.5, -1)
    closeButton.AnchorPoint = Vector2.new(1, 0.5)
    closeButton.Text = "Ã—"
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 18
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.BackgroundColor3 = Color3.fromRGB(220, 80, 80)
    closeButton.BorderSizePixel = 0
    closeButton.Visible = true
    closeButton.Parent = titleBar
    ApplyRoundedCorners(closeButton, 6)
    ApplyEnhancedGlowEffect(closeButton, "element")
    
    closeButton.MouseButton1Click:Connect(function()
        BoostProtectionManager:StopAllProtections()
        screenGui:Destroy()
    end)

    local twinButton = Instance.new("TextButton")
    twinButton.Size = UDim2.new(0, 25, 0, 25)
    twinButton.Position = UDim2.new(1, -35, 0.5, -1)
    twinButton.AnchorPoint = Vector2.new(1, 0.5)
    twinButton.Text = "M"
    twinButton.Font = Enum.Font.GothamBold
    twinButton.TextSize = 12
    twinButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    twinButton.BackgroundColor3 = Color3.fromRGB(100, 100, 180)
    twinButton.BorderSizePixel = 0
    twinButton.Visible = true
    twinButton.Parent = titleBar
    ApplyRoundedCorners(twinButton, 6)
    ApplyEnhancedGlowEffect(twinButton, "element")

    -- è¾“å…¥æ¡†å‡½æ•°
    local function CreateInputBox(posY, placeholder, sizeX, posX)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(sizeX, 0, 0, 28)
        container.Position = UDim2.new(posX, 0, posY, 0)
        container.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
        container.BorderSizePixel = 0
        container.Visible = true
        container.Parent = mainFrame
        
        ApplyRoundedCorners(container, 6)
        ApplyEnhancedGlowEffect(container, "element")
        
        local box = Instance.new("TextBox")
        box.Size = UDim2.new(1, -10, 1, -6)
        box.Position = UDim2.new(0, 5, 0, 3)
        box.PlaceholderText = placeholder
        box.BackgroundTransparency = 1
        box.TextColor3 = Color3.fromRGB(255, 255, 255)
        box.Font = Enum.Font.Gotham
        box.TextSize = 12
        box.PlaceholderColor3 = Color3.fromRGB(180, 180, 200)
        box.Text = ""
        box.Visible = true
        box.Parent = container
        
        return box
    end

    -- åˆ›å»ºè¾“å…¥æ¡†
    local musicIDBox = CreateInputBox(0.2, "è¾“å…¥éŸ³ä¹ID...", 0.9, 0.05)
    local volumeBox = CreateInputBox(0.4, "éŸ³é‡ 0.1-100", 0.4, 0.05)
    local pitchBox = CreateInputBox(0.4, "éŸ³è°ƒ 0.1-100", 0.4, 0.55)

    -- åŠŸèƒ½æŒ‰é’®å‡½æ•°
    local function CreateStyledButton(text, posX, posY, sizeX, color)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(sizeX, 0, 0, 32)
        btn.Position = UDim2.new(posX, 0, posY, 0)
        btn.Text = text
        btn.Font = Enum.Font.GothamSemibold
        btn.TextSize = 13
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.BackgroundColor3 = color
        btn.AutoButtonColor = true
        btn.BorderSizePixel = 0
        btn.Visible = true
        btn.Parent = mainFrame
        
        btn.MouseEnter:Connect(function()
            local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = tweenService:Create(btn, tweenInfo, {BackgroundColor3 = Color3.fromRGB(
                math.min(color.R * 255 + 15, 255),
                math.min(color.G * 255 + 15, 255),
                math.min(color.B * 255 + 15, 255)
            )})
            tween:Play()
        end)
        
        btn.MouseLeave:Connect(function()
            local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = tweenService:Create(btn, tweenInfo, {BackgroundColor3 = color})
            tween:Play()
        end)
        
        ApplyRoundedCorners(btn, 8)
        ApplyEnhancedGlowEffect(btn, "element")
        return btn
    end

    local playButtonDefaultColor = Color3.fromRGB(0, 162, 255)
    local playButtonSuccessColor = Color3.fromRGB(70, 200, 100)
    local playButtonFailureColor = Color3.fromRGB(220, 80, 80)
    
    local playButton = CreateStyledButton("æ’­æ”¾", 0.05, 0.65, 0.4, playButtonDefaultColor)
    local stopButton = CreateStyledButton("åœæ­¢", 0.55, 0.65, 0.4, Color3.fromRGB(220, 80, 80))

    -- åˆ‡æ¢æŒ‰é’®å‡½æ•°
    local function CreateToggleButton(text, posX, posY, sizeX, color)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(sizeX, 0, 0, 24)
        btn.Position = UDim2.new(posX, 0, posY, 0)
        btn.Text = text
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 11
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.BackgroundColor3 = color
        btn.AutoButtonColor = true
        btn.BorderSizePixel = 0
        btn.Visible = true
        btn.Parent = mainFrame
        
        ApplyRoundedCorners(btn, 6)
        ApplyEnhancedGlowEffect(btn, "element")
        return btn
    end

    -- é‡æ–°è°ƒæ•´æŒ‰é’®å¸ƒå±€
    local modeButton = CreateToggleButton("æ™ºèƒ½æ¨¡å¼", 0.05, 0.85, 0.4, Color3.fromRGB(150, 100, 220))
    local loopToggle = CreateToggleButton("å¾ªç¯: ON", 0.55, 0.85, 0.3, Color3.fromRGB(70, 150, 200))
    local boostToggle = CreateToggleButton("Boost", 0.85, 0.85, 0.1, Color3.fromRGB(120, 120, 120))

    -- åˆ†éš”çº¿
    local separator = Instance.new("Frame")
    separator.Size = UDim2.new(1, -20, 0, 1)
    separator.Position = UDim2.new(0, 10, 0.58, 0)
    separator.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    separator.BorderSizePixel = 0
    separator.Visible = true
    separator.Parent = mainFrame

    -- æ‹–åŠ¨ç³»ç»Ÿ
    mainFrame.Active = true
    mainFrame.Draggable = true

    -- éŸ³é¢‘æ§åˆ¶ç³»ç»Ÿ
    local soundSystem = {
        LoopEnabled = true,
        BoostEnabled = false,
        ActiveSounds = {},
        RemoteEvent = nil,
        CurrentMode = "auto",
        ModeNames = {auto = "æ™ºèƒ½æ¨¡å¼", mode1 = "ç¼“å­˜æ¨¡å¼", mode2 = "éå†æ¨¡å¼"},
        ModeColors = {
            auto = Color3.fromRGB(150, 100, 220),
            mode1 = Color3.fromRGB(100, 180, 120),
            mode2 = Color3.fromRGB(220, 140, 100)
        },
        LastSoundName = nil,
        TwinMode = false
    }
    
    -- æ›´æ–°æŒ‰é’®é¢œè‰²å‡½æ•°
    local function UpdateBoostButtonColor()
        if soundSystem.CurrentMode == "mode2" and soundSystem.BoostEnabled then
            -- Mæ¨¡å¼+Boostå¯ç”¨ï¼šçº¢è‰²
            boostToggle.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        elseif soundSystem.BoostEnabled then
            -- å…¶ä»–æ¨¡å¼+Boostå¯ç”¨ï¼šé»„è‰²
            boostToggle.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
        else
            -- Boostæœªå¯ç”¨ï¼šç°è‰²
            boostToggle.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        end
    end
    
    local function UpdateModeButton()
        modeButton.Text = soundSystem.ModeNames[soundSystem.CurrentMode]
        modeButton.BackgroundColor3 = soundSystem.ModeColors[soundSystem.CurrentMode]
        -- æ›´æ–°BoostæŒ‰é’®é¢œè‰²
        UpdateBoostButtonColor()
    end
    
    modeButton.MouseButton1Click:Connect(function()
        soundSystem.CurrentMode = soundSystem.CurrentMode == "auto" and "mode1" or 
                                 soundSystem.CurrentMode == "mode1" and "mode2" or "auto"
        UpdateModeButton()
    end)
    
    local function UpdateTwinModeButton()
        twinButton.BackgroundColor3 = soundSystem.TwinMode and 
            Color3.fromRGB(70, 130, 200) or Color3.fromRGB(100, 100, 180)
    end
    
    twinButton.MouseButton1Click:Connect(function()
        soundSystem.TwinMode = not soundSystem.TwinMode
        UpdateTwinModeButton()
    end)
    
    -- Boostå¼€å…³ç‚¹å‡»äº‹ä»¶
    boostToggle.MouseButton1Click:Connect(function()
        soundSystem.BoostEnabled = not soundSystem.BoostEnabled
        BoostProtectionManager.Enabled = soundSystem.BoostEnabled
        
        if soundSystem.BoostEnabled then
            boostToggle.Text = "Boost"
            print("ğŸš€ Boostæ¨¡å¼å·²å¯ç”¨")
        else
            boostToggle.Text = "Boost"
            BoostProtectionManager:StopAllProtections()
            print("âš¡ Boostæ¨¡å¼å·²å…³é—­")
        end
        
        -- æ›´æ–°æŒ‰é’®é¢œè‰²
        UpdateBoostButtonColor()
    end)
    
    UpdateModeButton()
    UpdateTwinModeButton()
    
    -- éŸ³ä¹æ§åˆ¶åŠŸèƒ½
    local function generateEnhancedSoundName(musicID)
        local prefixes = {"EngineSound", "Vehicleengine", "AmbientTrack", "DEV", "EnvironmentSFX"}
        local suffixes = {"System", "suffer", "Manager", "Player", "Source", "Device"}
        local numbers = {"001", "02", "3", "004", "5"}
        return prefixes[math.random(#prefixes)].."_"..suffixes[math.random(#suffixes)].."_"..numbers[math.random(#numbers)]
    end

    local function ValidateAndCleanParameters(rawMusicID, rawVolume, rawPitch)
        local musicID = tostring(rawMusicID):gsub("%D+", "")
        if #musicID < 6 then
            return nil, nil, nil
        end
        local volume = tonumber(rawVolume) or 1
        local pitch = tonumber(rawPitch) or 1
        return musicID, math.clamp(volume, 0.1, 100), math.clamp(pitch, 0.1, 100)
    end

    local function SafeStopSound(soundID)
        local stopped = false
        for _, location in ipairs({workspace, replicatedStorage}) do
            for _, obj in ipairs(location:GetDescendants()) do
                if obj:IsA("RemoteEvent") and obj.Name == "AC6_FE_Sounds" then
                    pcall(function()
                        obj:FireServer("stopSound", soundID)
                        stopped = true
                    end)
                end
            end
        end
        return stopped
    end

    local function StopAllSounds()
        if #soundSystem.ActiveSounds == 0 then return end
        
        local soundsToStop = {}
        for _, soundID in ipairs(soundSystem.ActiveSounds) do
            table.insert(soundsToStop, soundID)
        end
        
        for _, soundID in ipairs(soundsToStop) do
            SafeStopSound(soundID)
            BoostProtectionManager:DisableProtection(soundID)
        end
        
        soundSystem.ActiveSounds = {}
        soundSystem.LastSoundName = nil
    end

    local function EnhancedMode1_Play(musicID, volume, pitch, loopEnabled)
        if soundSystem.RemoteEvent and not soundSystem.RemoteEvent:IsDescendantOf(game) then
            soundSystem.RemoteEvent = nil
        end
        
        if not soundSystem.RemoteEvent then
            for _, location in ipairs({workspace, replicatedStorage}) do
                for _, obj in ipairs(location:GetDescendants()) do
                    if obj:IsA("RemoteEvent") and obj.Name == "AC6_FE_Sounds" then
                        soundSystem.RemoteEvent = obj
                        break
                    end
                end
                if soundSystem.RemoteEvent then break end
            end
        end
        
        if not soundSystem.RemoteEvent then 
            warn("[AC6æ’­æ”¾å™¨] æœªæ‰¾åˆ°AC6_FE_Soundsè¿œç¨‹äº‹ä»¶")
            return false 
        end
        
        local soundName = generateEnhancedSoundName(musicID)
        
        local success = pcall(function()
            soundSystem.RemoteEvent:FireServer("newSound", soundName, workspace, 
                              "rbxassetid://"..musicID, pitch, volume, loopEnabled)
            soundSystem.RemoteEvent:FireServer("playSound", soundName)
        end)
        
        if success then
            table.insert(soundSystem.ActiveSounds, soundName)
            soundSystem.LastSoundName = soundName
            
            -- ä»…åœ¨éåŸå§‹ä»£ç æ¨¡å¼ä¸‹å¯ç”¨Boostä¿æŠ¤
            if soundSystem.BoostEnabled and soundSystem.CurrentMode ~= "mode2" then
                BoostProtectionManager:EnableProtection(soundName)
            end
            
            return true
        else
            soundSystem.RemoteEvent = nil
            return false
        end
    end

    -- ä¿®æ”¹åçš„éå†æ¨¡å¼ï¼ˆMæ¨¡å¼ï¼‰- å®Œå…¨ä½¿ç”¨åŸå§‹ä»£ç 
    local function EnhancedMode2_Play(musicID, volume, pitch, loopEnabled)
        -- æ£€æŸ¥æ˜¯å¦åŒæ—¶å¯ç”¨Mæ¨¡å¼å’ŒBoostæ¨¡å¼
        if soundSystem.CurrentMode == "mode2" and soundSystem.BoostEnabled then
            -- ğŸš€ å®Œå…¨ä½¿ç”¨åŸå§‹æ ¸å¿ƒä»£ç ï¼ˆæ— ä»»ä½•ä¿®æ”¹ï¼‰
            print("ğŸ”´ ä½¿ç”¨å®Œå…¨åŸå§‹ä»£ç æ¨¡å¼ï¼ˆMæ¨¡å¼+Boostï¼‰")
            
            -- å®Œå®Œå…¨å…¨ä½¿ç”¨åŸå§‹ä»£ç ï¼Œåªæ›¿æ¢å‚æ•°
            local sound = true  -- å›ºå®šä¸ºtrueï¼Œè¡¨ç¤ºæ’­æ”¾
            local ID = "rbxassetid://"..musicID  -- ä½¿ç”¨è¾“å…¥çš„éŸ³ä¹ID
            local Name = "get troll"  -- ä½¿ç”¨åŸå§‹å›ºå®šåç§°
            local Volume = volume  -- ä½¿ç”¨è¾“å…¥çš„éŸ³é‡
            local Pitch = pitch   -- ä½¿ç”¨è¾“å…¥çš„éŸ³è°ƒ
            
            local playedSuccessfully = false
            
            -- å®Œå®Œå…¨å…¨ä½¿ç”¨åŸå§‹å¾ªç¯ç»“æ„å’Œé€»è¾‘
            for i,v in pairs(game:GetService("Workspace"):GetDescendants()) do
                if v:IsA("RemoteEvent") and v.Name == "AC6_FE_Sounds" then
                    if sound == true then
                        -- å®Œå…¨ä½¿ç”¨åŸå§‹ä»£ç ï¼Œç›´æ¥è§¦å‘ï¼Œæ— é”™è¯¯å¤„ç†
                        v:FireServer("newSound", Name, workspace, ID, Pitch, Volume, loopEnabled)
                        v:FireServer("playSound", Name)
                        
                        playedSuccessfully = true
                        -- æ·»åŠ åˆ°æ´»åŠ¨å£°éŸ³åˆ—è¡¨
                        table.insert(soundSystem.ActiveSounds, Name)
                        soundSystem.LastSoundName = Name
                        
                        -- åŸå§‹ä»£ç æ¨¡å¼ä¸‹ä¸å¯ç”¨Boostä¿æŠ¤
                        -- å®Œå…¨æŒ‰ç…§åŸå§‹é€»è¾‘ï¼šå¦‚æœä¸å¯ç”¨Twinæ¨¡å¼å°±break
                        if not soundSystem.TwinMode then
                            break
                        end
                    end
                end
            end
            
            return playedSuccessfully
        else
            -- åŸæœ‰Mæ¨¡å¼ä»£ç ï¼ˆéBoostæ¨¡å¼ï¼‰
            local soundName = generateEnhancedSoundName(musicID)
            local playedSuccessfully = false
            local remoteEvents = {}
            
            for _, location in ipairs({workspace, replicatedStorage}) do
                for _, v in ipairs(location:GetDescendants()) do
                    if v:IsA("RemoteEvent") and v.Name == "AC6_FE_Sounds" then
                        table.insert(remoteEvents, v)
                    end
                end
            end
            
            if #remoteEvents == 0 then 
                warn("[AC6æ’­æ”¾å™¨] éå†æ¨¡å¼ï¼šæœªæ‰¾åˆ°ä»»ä½•AC6è¿œç¨‹äº‹ä»¶")
                return false 
            end
            
            for i = #remoteEvents, 2, -1 do
                local j = math.random(i)
                remoteEvents[i], remoteEvents[j] = remoteEvents[j], remoteEvents[i]
            end
            
            for _, remote in ipairs(remoteEvents) do
                local success = pcall(function()
                    remote:FireServer("newSound", soundName, workspace, 
                                      "rbxassetid://"..musicID, pitch, volume, loopEnabled)
                    remote:FireServer("playSound", soundName)
                end)
                if success then
                    playedSuccessfully = true
                    if not soundSystem.TwinMode then break end
                end
            end
            
            if playedSuccessfully then
                table.insert(soundSystem.ActiveSounds, soundName)
                soundSystem.LastSoundName = soundName
                
                if soundSystem.BoostEnabled then
                    BoostProtectionManager:EnableProtection(soundName)
                end
            end
            return playedSuccessfully
        end
    end
    
    local function EnhancedAutoMode_Play(musicID, volume, pitch, loopEnabled)
        return EnhancedMode1_Play(musicID, volume, pitch, loopEnabled) or 
               EnhancedMode2_Play(musicID, volume, pitch, loopEnabled)
    end
    
    -- æ’­æ”¾æ§åˆ¶
    local function handlePlayback()
        local rawMusicID = musicIDBox.Text
        local rawVolume = volumeBox.Text
        local rawPitch = pitchBox.Text
        
        local musicID, volume, pitch = ValidateAndCleanParameters(rawMusicID, rawVolume, rawPitch)
        if not musicID then
            playButton.BackgroundColor3 = playButtonFailureColor
            task.delay(0.5, function()
                playButton.BackgroundColor3 = playButtonDefaultColor
            end)
            return
        end
        
        local success = false
        if soundSystem.CurrentMode == "mode1" then
            success = EnhancedMode1_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        elseif soundSystem.CurrentMode == "mode2" then
            success = EnhancedMode2_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        else
            success = EnhancedAutoMode_Play(musicID, volume, pitch, soundSystem.LoopEnabled)
        end
        
        if success then
            playButton.BackgroundColor3 = playButtonSuccessColor
        else
            playButton.BackgroundColor3 = playButtonFailureColor
        end
        
        task.delay(0.5, function()
            playButton.BackgroundColor3 = playButtonDefaultColor
        end)
    end

    local function handleStop()
        StopAllSounds()
        stopButton.BackgroundColor3 = Color3.fromRGB(250, 100, 100)
        task.delay(0.5, function()
            stopButton.BackgroundColor3 = Color3.fromRGB(220, 80, 80)
        end)
    end
    
    playButton.MouseButton1Click:Connect(handlePlayback)
    stopButton.MouseButton1Click:Connect(handleStop)
    
    loopToggle.MouseButton1Click:Connect(function()
        soundSystem.LoopEnabled = not soundSystem.LoopEnabled
        loopToggle.Text = soundSystem.LoopEnabled and "å¾ªç¯: ON" or "å¾ªç¯: OFF"
        loopToggle.BackgroundColor3 = soundSystem.LoopEnabled and 
            Color3.fromRGB(70, 150, 200) or Color3.fromRGB(120, 120, 140)
    end)

    -- è¾‰å…‰æ•ˆæœæ›´æ–°å¾ªç¯
    local connection
    connection = runService.Heartbeat:Connect(function()
        -- å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¾‰å…‰åŠ¨ç”»æ•ˆæœ
    end)

    -- æ¸…ç†å‡½æ•°
    screenGui.Destroying:Connect(function()
        if connection then
            connection:Disconnect()
        end
        BoostProtectionManager:StopAllProtections()
    end)

    print("âœ… æœ€ç»ˆä¿®å¤ç‰ˆéŸ³ä¹æ’­æ”¾å™¨UIå·²åŠ è½½ - å®Œå…¨åŸå§‹ä»£ç æ¨¡å¼ï¼")
    return screenGui
end

-- å®‰å…¨æ‰§è¡ŒUIåˆ›å»º
local success, result = pcall(function()
    return CreateFullUI()
end)

if not success then
    warn("âŒ UIåˆ›å»ºå¤±è´¥: " .. tostring(result))
else
    print("ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å°±ç»ª - Mæ¨¡å¼+Boostå°†ä½¿ç”¨å®Œå…¨åŸå§‹ä»£ç ï¼Œæ— ä¿æŠ¤æœºåˆ¶ï¼")
end
